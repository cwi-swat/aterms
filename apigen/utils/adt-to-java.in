#!/bin/sh

# {{{ variables

PRG=`basename $0`
JAVA_ATERM=@JAVA_ATERM@
prefix=@prefix@

# }}}

# {{{ usage()

usage() {
cat << ENDCAT >&2
Usage: $PRG -i <adt-file> [options]

Parameters:

  -i | --input <FILE>     specify input adt                [not specified]
  -c | --classpath <PATH> set classpath                    [see below]
  -f | --folding          folding enabled                  [off]
  -o | --output <DIR>     specify output directory         [.]
  -p | --package <STR>    specify package                  [""]
  -m | --import <PKG>     specify extra import package     [see below]
  -n | --name <NAME>      specify name of api              [improvised]
  -t | --visitable        visitable enabled                [off]
  -j | --jtom             generate jtom signature          [off]
  -v | --verbose          be verbose during generation     [off]
  -h | --help             display this information

Default locations:
  classes = ${CLASSES}:${JAVA_ATERM}

Example: $PRG -i Booleans.adt --package sdf -m 'java.util.*'

ENDCAT
}

# }}}

# {{{  info()

info () {
  if [ $VERBOSE -gt 0 ]; then
    echo $* >&2
   fi
}

# }}}
# {{{  error()

error() {
  echo "${PRG}: $*" >&2
  exit 1
}

# }}}
# {{{  require()

require() {
  [ -f $1 ] || error "no such file: $1"
}

# }}}

# {{{  default settings

# settings/options
INPUT=""
VERBOSE=0
FOLDING=0
VISITABLE=0
JTOM=0
NAME=""

# data needed
CLASSES=${prefix}/classes

# }}}

# {{{  handle command line options

if [ $# -eq 0 ]; then
  usage
  exit 1
fi

while [ $# -gt 0 ]
do
  case $1 in
    -i | --input)
      shift; INPUT="$INPUT --input $1" ;;
 
    -c | --classpath)
      shift; CLASSES=$1;;

    -f | --folding)
      FOLDING=1 ;;
      
    -o | --output)
      shift; OUTPUT=$1 ;;
      
    -p | --package)
      shift; OPT_PACKAGE=$1 ;;

    -m | --import)
      shift; OPT_IMPORTS="${OPT_IMPORTS} --import $1" ;;

    -n | --name)
      shift; NAME="$1";;

    -t | --visitable)
      VISITABLE=1 ;;
    
    -j | --jtom)
      JTOM=1 ;;
      
    -v | --verbose)
      VERBOSE=1 ;;
  
    -h | --help)
      usage; exit 0 ;;

    *)
      error "unknown option: $1"
  esac
  shift
done

# }}}

# {{{ sanity checks and variable setup

if [ "a${OUTPUT}" = "a" ]; then
  OUTPUT="."
fi

if [ "a${OPT_PACKAGE}" = "a" ]; then
  OPT_PACKAGE=""
else
  OPT_PACKAGE="--package ${OPT_PACKAGE}"
fi

if [ $VERBOSE -gt 0 ]; then
  OPT_VERBOSE="--verbose"
else
  OPT_VERBOSE=""
fi

if [ $FOLDING -gt 0 ]; then
  OPT_FOLDING="--folding"
else
  OPT_FOLDING=""
fi

if [ $VISITABLE -gt 0 ]; then
  OPT_VISITABLE="--visitable"
else
  OPT_VISITABLE=""
fi

if [ $JTOM -gt 0 ]; then
  OPT_JTOM="--jtom"
else
  OPT_JTOM=""
fi

if [ "a${NAME}" = "a" ]; then
  OPT_NAME=""
else
  OPT_NAME="--name ${NAME}"
fi

  
# }}}

# {{{  generate Java code from ADT
java  -classpath ${CLASSES}:${JAVA_ATERM} \
          apigen.gen.java.Main \
	  ${INPUT} \
	  --output ${OUTPUT} \
	  ${OPT_IMPORTS} \
	  ${OPT_PACKAGE} \
	  ${OPT_VERBOSE} \
	  ${OPT_FOLDING} \
	  ${OPT_VISITABLE} \
	  ${OPT_JTOM} \
	  ${OPT_NAME}

# }}}
