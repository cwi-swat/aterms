#! /bin/sh

PRG=`basename $0`
DATE=`date`
# {{{ autoconf variables

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
datadir=@datadir@
SGLRBIN=@SGLRBIN@
EVALBIN=@EVALBIN@
ASOURCEBIN=@ASOURCEBIN@
PKGDATA=${datadir}/@PACKAGE@

# }}}

# {{{ usage()

usage() {
cat << ENDCAT >&2
Usage: $PRG [--expand-cons | --remove-cons] <SDF2-module>

  --expand-cons: propagate  cons-annotations into generated term-patterns
  --remove-cons: do not put cons-annotations into generated term-patterns

Example: $PRG --remove-cons Booleans.sdf

Default: --expand-cons
ENDCAT
}

# }}}

# {{{  Commandline argument parsing

if test $# -lt 1 -o $# -gt 2
then
  usage
  exit 1
fi

CONSOPT='cons-expand'
case $1 in
  --remove-cons)
    CONSOPT='cons-remove'
    shift;;
  --expand-cons)
    CONSOPT='cons-expand'
    shift;;
esac

# }}}
# {{{ Variable section

MODULE=$1
MODULE=`basename $MODULE .sdf`
MODULE=`basename $MODULE .sdf2`
SDFFILE="$1"
ADTFILE="${MODULE}.adt"

SGLR=${SGLRBIN}/sglr
ASOURCE=${ASOURCEBIN}/asource

SDF2TOADT=${bindir}/Sdf2-to-ADT
EVALUATOR=${EVALBIN}/asfe
APPLYFUNC=${EVALBIN}/apply-function

APITABLE=${PKGDATA}/Sdf2-to-ADT.trm.tbl
ADDLABELS=${PKGDATA}/AddLabels.asf

# }}}

# {{{ Sanity checks

if test ! -f ${SDFFILE}
then
  echo "could not open sdf-file: ${SDFFILE}" >&2
  exit 1
fi

# }}}

# Now here's a candidate for improvement!

(${SGLR} -1 -p ${APITABLE} -s SDF \
  | ${APPLYFUNC} -f add-labels -s SDF -m AddLabels \
  | ${EVALUATOR} -w on -e ${ADDLABELS} \
  | ${ASOURCE}) \
  < ${SDFFILE} \
  > ${SDFFILE}.lbl.tmp

(echo "sdf-to-adt(`cat`, $CONSOPT)" \
  | ${SGLR} -1 -p ${APITABLE} -s ATerm \
  | ${SDF2TOADT} \
  | ${ASOURCE}) \
  < ${SDFFILE}.lbl.tmp \
  > ${ADTFILE}

/bin/rm -f ${SDFFILE}.lbl.tmp
