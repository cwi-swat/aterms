#!/bin/sh

# {{{ variables

     prefix=@prefix@
exec_prefix=@exec_prefix@
     bindir=@bindir@
    datadir=@datadir@
        PRG=`basename $0`

# }}}

# {{{ usage()

usage() {
cat << ENDCAT >&2
Usage: $PRG -i <adt-file> -p <prologue> [options]

Parameters:

  -i | --input <FILE>     specify input adt                [not specified]
  -p | --prologue <FILE>  specify prologue-code file       [not specified]
  -o | --output <STEM>    generate <STEM>.[ch] etc.        [improvised]
  -P | --prefix <STR>     specify API-prefix               [""]
  -c | --classpath <PATH> override CGen classes            [see below]
  -d | --dicttoc <FILE>   override default dicttoc         [see below]
  -v | --verbose          be verbose during generation     [off]
  -h | --help             display this information

Default locations:
  classes = ${CGEN}
  dicttoc = ${DICTTOC}

Example: $PRG -i Booleans.adt -prefix SDF -prologue Booleans.pro

ENDCAT
}

# }}}

# {{{  info()

info () {
  if [ $VERBOSE -gt 0 ]; then
    echo $* >&2
   fi
}

# }}}
# {{{  error()

error() {
  echo "${PRG}: $*" >&2
  exit 1
}

# }}}
# {{{  require()

require() {
  [ -f $1 ] || error "no such file: $1"
}

# }}}

# {{{  default settings

# settings/options
   INPUT=""
  PREFIX=""
PROLOGUE=""
 VERBOSE=0

# data needed
   CGEN=${prefix}/classes
DICTTOC=${bindir}/dicttoc

# }}}

# {{{  handle command line options

if [ $# -eq 0 ]; then
  usage
  exit 1
fi

while [ $# -gt 0 ]
do
  case $1 in
    -i | --input)
      shift; INPUT=$1 ;;

	-o | --output)
	  shift; OUTPUT=$1 ;;

    -p | --prologue)
      shift; PROLOGUE=$1 ;;

    -P | --prefix)
      shift; PREFIX=$1 ;;

    -c | --classpath)
      shift; CGEN=$1 ;;

    -d | --dicttoc)
      shift; DICTTOC=$1 ;;

    -v | --verbose)
      VERBOSE=1 ;;

    -h | --help)
      usage; exit 0 ;;

    *)
      error "unknown option: $1"
  esac
  shift
done

# }}}

# {{{ sanity checks and variable setup

if [ "a${INPUT}" == "a" ]; then
  error "no input file specified (use -i <file>)"
else
  require ${INPUT}
fi

if [ "a${PROLOGUE}" == "a" ]; then
  error "no prologue file specified (use -p <file>)"
else
  require ${PROLOGUE}
fi

if [ "a${OUTPUT}" == "a" ]; then
  OUTPUT=`basename ${INPUT} | cut -d. -f1`
  info "Improvising output-stem: ${OUTPUT}"
fi

if [ "a${PREFIX}" == "a" ]; then
  OPTIONAL_PREFIX=""
else
  OPTIONAL_PREFIX="-prefix ${PREFIX}"
fi

# }}}

# {{{  generate C code from ADT

java  -classpath ${CGEN} apigen.c.CGen \
	  -input ${INPUT} \
	  -output ${OUTPUT} \
	  -prologue ${PROLOGUE} \
	  ${OPTIONAL_PREFIX}

${DICTTOC} -dict ${OUTPUT}.dict

# }}}
