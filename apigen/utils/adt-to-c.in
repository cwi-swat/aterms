#!/bin/sh

# {{{ variables

     PRG=`basename $0`
  prefix=@prefix@
  ATERM=@ATERM@
  JAVA_ATERM=@JAVA_ATERM@
  SHARED_OBJECTS=@SHARED_OBJECTS@
ATERMBIN=@ATERMBIN@

# }}}

# {{{ usage()

usage() {
cat << ENDCAT >&2
Usage: $PRG -i <adt-file> [options]

Parameters:

  -i | --input <FILE>     specify an input adt             <multiple allowed>
  -o | --output <DIR>     specify output directory         ["."]
  -n | --name <api-name>  will generate <api-name>.[ch]    <obligatory>
  -p | --prologue <FILE>  specify prologue-code file       [""]
  -P | --prefix <STR>     specify API-prefix               [""]
  -c | --classpath <PATH> override CGen classes            [see below]
  -C | --compat-term      generate old term conv. macros   [off]
  -d | --dicttoc <FILE>   override default dicttoc         [see below]
  -t | --no-timestamp     do not output timestamps         [off]
  -j | --jtom             generate jtom signature          [off]
  -J | --jtype            generate type-prefix for jtom    [off]
  -v | --verbose          be verbose during generation     [off]
  -h | --help             display this information

Default locations:
  classes = ${CGEN}:${JAVA_ATERM}:${SHARED_OBJECTS}
  dicttoc = ${DICTTOC}

Example: $PRG -i Booleans.adt --prefix SDF --prologue Booleans.pro

ENDCAT
}

# }}}

# {{{  info()

info () {
  if [ $VERBOSE -gt 0 ]; then
    echo $* >&2
   fi
}

# }}}
# {{{  error()

error() {
  echo "${PRG}: $*" >&2
  exit 1
}

# }}}
# {{{  require()

require() {
  [ -f $1 ] || error "no such file: $1"
}

# }}}

# {{{  default settings

# settings/options
INPUT=""
OUTPUT="."
PREFIX=""
PROLOGUE=""
VERBOSE=0
TIMESTAMPS=1
COMPAT=0
JTOM=0
JTYPE=0

# data needed
   CGEN=${prefix}/classes
DICTTOC=${ATERMBIN}/dicttoc

# }}}

# {{{  handle command line options

if [ $# -eq 0 ]; then
  usage
  exit 1
fi

while [ $# -gt 0 ]
do
  case $1 in
    -i | --input)
      shift; INPUT="$INPUT -input $1" ;;

    -o | --output)
      shift; OUTPUT=$1 ;;

    -n | --name)
      shift; NAME=$1 ;;

    -p | --prologue)
      shift; PROLOGUE=$1 ;;

    -P | --prefix)
      shift; PREFIX=$1 ;;

    -c | --classpath)
      shift; CGEN=$1 ;;

    -C | --compat-term)
      COMPAT=1 ;;

    -d | --dicttoc)
      shift; DICTTOC=$1 ;;

    -t | --no-timestamps)
      shift; TIMESTAMPS=0 ;;

    -v | --verbose)
      VERBOSE=1 ;;

    -j | --jtom)
      JTOM=1 ;;

    -J | --jtype)
      JTYPE=1 ;;

    -h | --help)
      usage; exit 0 ;;

    *)
      error "unknown option: $1"
  esac
  shift
done

# }}}

# {{{ sanity checks and variable setup

if [ "a${PROLOGUE}" = "a" ]; then
  OPTIONAL_PROLOGUE=""
else
  require ${PROLOGUE}
  OPTIONAL_PROLOGUE="-prologue ${PROLOGUE}"
fi

if [ "a${PREFIX}" = "a" ]; then
  OPTIONAL_PREFIX=""
else
  OPTIONAL_PREFIX="-prefix ${PREFIX}"
fi

if [ "${COMPAT}" = "1" ]; then
  OPTIONAL_COMPAT="-compatible:term"
else
  OPTIONAL_COMPAT=""
fi

if [ $JTOM -gt 0 ]; then
  OPTIONAL_JTOM="-jtom"
else
  OPTIONAL_JTOM=""
fi

if [ $JTYPE -gt 0 ]; then
  OPTIONAL_JTYPE="-jtype"
else
  OPTIONAL_JTYPE=""
fi

# }}}

# {{{  generate C code from ADT

java \
  -classpath ${CGEN}:${JAVA_ATERM}:${SHARED_OBJECTS} \
  apigen.gen.c.Main \
  ${INPUT} \
  -output ${OUTPUT} \
  -name ${NAME} \
  ${OPTIONAL_PROLOGUE} \
  ${OPTIONAL_PREFIX} \
  ${OPTIONAL_COMPAT} \
  ${OPTIONAL_JTOM} \
  ${OPTIONAL_JTYPE}

if [ $TIMESTAMPS -gt 0 ]; then
  ${DICTTOC} -dict ${NAME}.dict
else
  ${DICTTOC} -no-date -dict ${NAME}.dict
fi

# }}}
