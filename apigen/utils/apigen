#!/bin/sh

PRG=`basename $0`
DATE=`date`

# {{{ usage()

usage() {
cat << ENDCAT >&2
Usage: $PRG <api-prefix> <version>
Example: $PRG rolodex 1.0
Note that the api will be generated in the directory '<api-prefix>'!
ENDCAT
}

# }}}
# {{{ genConfigure()

genConfigure() {
cat << "ENDCAT" | \
sed -e "s/@APILIB@/${APILIB}/g" \
    -e "s/@APIVERSION@/${APIVERSION}/g" \
    -e "s/@DATE@/$DATE/g" \
    -e "s/@PRG@/$PRG/g" \
    > $1
dnl
dnl Generated by @PRG@ at @DATE@
dnl

APILIB=@APILIB@

AC_INIT(configure.in)
AM_INIT_AUTOMAKE(@APILIB@, @APIVERSION@)

dnl Our own version of libdir whose value is set dynamically
AC_SUBST(INSTLIBDIR)
INSTLIBDIR="$libdir"

AC_REQUIRE([AC_PROG_CC])

dnl Which compiler to use?
AC_PROG_CC

dnl Do we need ranlib?
AC_PROG_RANLIB
AR=ar
AC_SUBST(AR)

dnl What commands are needed to set the variable MAKE in Makefiles?
AC_SET_MAKE

dnl Handle --with-aterm=... argument to configure
AC_ARG_WITH(aterm,
   [  --with-aterm=DIR        ATerm-library is in DIR], ATERM=${withval})
AC_SUBST(ATERM)

AC_ARG_WITH(aterm-inc,
   [  --with-aterm-inc=DIR    ATerm header files are in DIR],
   ATERMINC=${withval},ATERMINC=${ATERM}/include)
AC_SUBST(ATERMINC)

dnl Which files need updating?
AC_OUTPUT(
Makefile
,
)
ENDCAT
}

# }}}
# {{{ genMakefile()

genMakefile() {

# Generate Makefile.am
cat << "ENDCAT" | \
sed -e "s/@APILIB@/${APILIB}/g" \
    -e "s/@APIVERSION@/${APIVERSION}/g" \
    -e "s/@DATE@/$DATE/g" \
    -e "s/@PRG@/$PRG/g" \
    > $1
#
# Generated by @PRG@ at @DATE@
#

APILIB                  = @APILIB@

INCLUDES                = -I${ATERMINC}

lib_LIBRARIES           = lib@APILIB@.a

include_HEADERS         = @APILIB@.h

lib@APILIB@_a_SOURCES   = @APILIB@.c @APILIB@_dict.c
ENDCAT

# Generate NEWS, README, AUTHORS, ChangeLog as needed by Makefile.am
cat << "ENDCAT" | \
sed -e "s/@DATE@/$DATE/g" \
    -e "s/@PRG@/$PRG/g" \
    > NEWS
 * @DATE@: generated by @PRG@.
ENDCAT

cat << "ENDCAT" | \
sed -e "s/@APILIB@/${APILIB}/g" \
    -e "s/@DATE@/$DATE/g" \
    -e "s/@PRG@/$PRG/g" \
    > README
The files in this directory are part of the generated "@APILIB@"-library.
This library was generated by @PRG@ at @DATE@.
ENDCAT

cat << "ENDCAT" | \
sed -e "s/@PRG@/$PRG/g" \
    > AUTHORS
This package was generated by @PRG@.
ENDCAT

cat << "ENDCAT" | \
sed -e "s/@DATE@/$DATE/g" \
    -e "s/@PRG@/$PRG/g" \
    > ChangeLog
 * @DATE@: generated by @PRG@.
ENDCAT
}

# }}}
# {{{ genReconf()

genReconf() {
cat << "ENDCAT" | sed -e "s/@DATE@/$DATE/g" > $1
#! /bin/sh

#
# Generated by @PRG@ at @DATE@
#

aclocal
autoconf
autoheader
automake -a

ENDCAT
chmod +x $1
}

# }}}

if test $# != 2
then
  usage
  exit 1
fi
# {{{ Variable section

APILIB=$1
APIVERSION=$2
APIFILE="${APILIB}.adt"
APIDIR="${APILIB}"
PROLOGUE="${APILIB}.pro"

SGLR=sglr
ASOURCE=asource
DICTTOC=dicttoc
INDENT=indent
RM="rm -f"

GENCAPI=/ufs/olivierp/Research/apigen/spec/c-source/Gen-C-API
EXTRACT=extract-api-files
TABLE=/ufs/olivierp/Research/apigen/spec/Gen-C-API.trm.tbl

# }}}

# {{{ Sanity checks

if test ! -f ${APIFILE}
then
  echo "could not open api-file: ${APIFILE}" >&2
  exit 1
fi

if test ! -f ${PROLOGUE}
then
  echo "could not open prologue-file: ${PROLOGUE}" >&2
  exit 1
fi

if test -e ${APIDIR} -a ! -d ${APIDIR}
then
  echo "${APIDIR} already exists, giving up!" >&2
  exit 1
fi

# }}}

mkdir -p ${APIDIR}

if test $? != 0
then
  echo "could not create ${APIDIR}" >&2
  exit 1
fi

cd ${APIDIR}

genConfigure "configure.in"
genMakefile "Makefile.am"
genReconf "reconf"

(echo "c-api: ${APILIB},`cat ../${PROLOGUE}`,"; cat ../${APIFILE}) | \
${SGLR} -1 -p ${TABLE} | \
${GENCAPI} | \
${ASOURCE} | \
${EXTRACT} -

${DICTTOC} -dict ${APILIB}.dict
${INDENT} ${APILIB}.[ch]
${RM} ${APILIB}.[ch]~
