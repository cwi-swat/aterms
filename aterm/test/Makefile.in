# vim:ts=8:sw=8

PRODUCT		= @PRODUCT@
VERSION		= @VERSION@
CURDATE		= `date`

srcdir		= @srcdir@
top_srcdir	= @top_srcdir@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@
libdir		= @libdir@
includedir  	= $(prefix)/include

CC_GCC		= @CC_GCC@
CC_CC		= @CC_CC@
CC_DBG		= @CC_DBG@
CC_PROF		= @CC_PROF@
CC_NS		= @CC_CC@

CFLAGS_CC	= @CFLAGS_CC@
CFLAGS_GCC	= @CFLAGS_GCC@
CFLAGS_DBG	= @CFLAGS_DBG@
CFLAGS_PROF	= @CFLAGS_PROF@
CFLAGS_NS	= @CFLAGS_CC@

DEFS_CC		= @DEFS_CC@
DEFS_GCC	= @DEFS_GCC@
DEFS_DBG	= @DEFS_DBG@
DEFS_PROF	= @DEFS_PROF@
DEFS_NS		= @DEFS_CC@ -DNO_SHARING

INCL_CC		= @INCL_CC@
INCL_GCC	= @INCL_GCC@
INCL_DBG	= @INCL_DBG@
INCL_PROF	= @INCL_PROF@
INCL_NS		= @INCL_CC@

LFLAGS_CC	= @LFLAGS_CC@
LFLAGS_GCC	= @LFLAGS_GCC@
LFLAGS_DBG	= @LFLAGS_DBG@
LFLAGS_PROF	= @LFLAGS_PROF@
LFLAGS_NS	= @LFLAGS_CC@ 

AT_LIBS		= ATerm
AF_LIBS		= AsFix
TB_LIBS		= # ATB
ALL_LIBS	= ${AT_LIBS} ${AF_LIBS} ${TB_LIBS}
ATERM_LIBS	= $(addprefix ${top_srcdir}/aterm/lib,  ${AT_LIBS})
ASFIX_LIBS	= $(addprefix ${top_srcdir}/asfix/lib,  ${AF_LIBS})
TOOLBUS_LIBS	= $(addprefix ${top_srcdir}/toolbus/lib,${TB_LIBS})
FULL_LIBS	= ${ATERM_LIBS} ${ASFIX_LIBS} ${TOOLBUS_LIBS}

LIB_CC		= $(addsuffix -cc.a,   ${FULL_LIBS})
LIB_GCC		= $(addsuffix -gcc.a,  ${FULL_LIBS})
LIB_DBG		= $(addsuffix -dbg.a,  ${FULL_LIBS})
LIB_PROF	= $(addsuffix -prof.a, ${FULL_LIBS})
LIB_NS		= $(addsuffix -ns.a,   ${FULL_LIBS})

LIBS_CC		= -L${top_srcdir}/aterm -L${top_srcdir}/asfix -L${top_srcdir}/toolbus \
		  $(addprefix -l, $(addsuffix -cc,   ${ALL_LIBS})) @LIBS@
LIBS_GCC	= -L${top_srcdir}/aterm -L${top_srcdir}/asfix -L${top_srcdir}/toolbus \
		  $(addprefix -l, $(addsuffix -gcc,  ${ALL_LIBS})) @LIBS@
LIBS_DBG	= -L${top_srcdir}/aterm -L${top_srcdir}/asfix -L${top_srcdir}/toolbus \
		  $(addprefix -l, $(addsuffix -dbg,  ${ALL_LIBS})) @LIBS@
LIBS_PROF	= -L${top_srcdir}/aterm -L${top_srcdir}/asfix -L${top_srcdir}/toolbus \
		  $(addprefix -l, $(addsuffix -prof, ${ALL_LIBS})) @LIBS@
LIBS_NS		= -L${top_srcdir}/aterm -L${top_srcdir}/asfix -L${top_srcdir}/toolbus \
		  $(addprefix -l, $(addsuffix -ns,   ${ALL_LIBS})) @LIBS@

INSTALL		= @INSTALL@
INSTALL_PRG	= @INSTALL_PRG@
INSTALL_DAT	= @INSTALL_DAT@

TOOLBUS		= @TOOLBUS@
INCL		= -I../asfix -I../aterm -I../toolbus
TESTPRGS	= stress-cc stress-gcc primes-cc primes-gcc asfixtest \
		  stress-ns primes-ns randgen termstats
TBTESTPRGS	= test-tool test-tool2
TESTSRCS	= stress.c asfixtest.c primes.c test-tool.c test-tool2.c \
		  randgen.c termstats.c
TESTOBJS	= stress.o asfixtest.o primes.o test-tool.o test-tool2.o
DISTFILES	= test.tb test2.tb Test.asfix test.trms error.trm Makefile.in \
		  test2.tifs ${TESTSRCS} .depend

all: $(TESTPRGS) $(TESTS)

toolbus: ${TBTESTPRGS}

clean:
	@CLEAN@ *.tif.c *.tif.h ${TESTPRGS}

dist: ${DISTFILES}
	@cp ${DISTFILES} ${DISTDIR}

install:

stress-cc: stress.c ${LIB_CC}
	$(CC_CC) $(CFLAGS_CC) $(DEFS_CC) $(INCL) $(LFLAGS) -o stress-cc stress.c $(LIBS_CC)

stress-gcc: stress.c ${LIB_DBG}
	$(CC_DBG) $(CFLAGS_DBG) $(DEFS_GCC) $(INCL) $(LFLAGS) -o stress-gcc stress.c $(LIBS_DBG)

stress-ns: stress.c ${LIB_NS}
	$(CC_NS) $(CFLAGS_NS) $(DEFS_NS) $(INCL) $(LFLAGS) -o stress-ns \
		stress.c $(LIBS_NS)

asfixtest: asfixtest.c ${LIB_DBG}
	$(CC_DBG) $(CFLAGS_DBG) $(DEFS_DBG) $(INCL) $(LFLAGS) -o asfixtest \
		asfixtest.c $(LIBS_DBG)

primes-cc: primes.c ${LIB_CC}
	$(CC_CC) $(CFLAGS_CC) $(DEFS_CC) $(INCL) $(LFLAGS) -o primes-cc primes.c $(LIBS_CC)

primes-ns: primes.c ${LIB_NS}
	$(CC_NS) $(CFLAGS_NS) $(DEFS_NS) $(INCL) $(LFLAGS) -o primes-ns primes.c $(LIBS_NS)

primes-gcc: primes.c ${LIB_DBG}
	$(CC_DBG) $(CFLAGS_DBG) $(INCL) $(LFLAGS) -o primes-gcc primes.c $(LIBS_DBG)

randgen: randgen.c ${LIB_CC}
	${CC_CC} $(CFLAGS_CC) $(DEFS_CC) $(INCL) $(LFLAGS) -o randgen randgen.c $(LIBS_CC) 

termstats: termstats.c ${LIB_CC}
	${CC_CC} $(CFLAGS_CC) $(DEFS_CC) $(INCL) $(LFLAGS) -o termstats termstats.c $(LIBS_CC) 

vararg1: vararg1.c ${LIB_DBG}
	${CC_DBG} ${CFLAGS_DBG} ${INCL} ${LFLAGS} -o vararg1 vararg1.c ${LIBS_DBG}

vararg2: vararg2.c ${LIB_DBG}
	${CC_DBG} ${CFLAGS_DBG} ${INCL} ${LFLAGS} -o vararg2 vararg2.c ${LIBS_DBG}

vararg3: vararg3.c ${LIB_DBG}
	${CC_DBG} ${CFLAGS_DBG} ${INCL} ${LFLAGS} -o vararg3 vararg3.c ${LIBS_DBG}

test-tool: test-tool.c ${LIB_DBG}
	$(CC_DBG) $(CFLAGS_DBG) $(INCL) $(LFLAGS) -o test-tool test-tool.c \
		-L../toolbus -lATB-dbg ${LIBS_DBG}

test-tool2: test-tool2.c tool2.tif.c tool2.tif.h ${LIB_DBG}
	$(CC_DBG) $(CFLAGS_DBG) $(INCL) $(LFLAGS) -o test-tool2 test-tool2.c \
		tool2.tif.c -L../toolbus -lATB-dbg ${LIBS_DBG}

tool2.tif.c tool2.tif.h: test2.tifs
	../toolbus/tifstoc -tool tool2 test2.tifs

test2.tifs: test2.tb
	$(TOOLBUS) -gentifs test2.tb
	

depend: tool2.tif.c tool2.tif.h
	$(CC_GCC) -MM $(DEFS) $(INCL) $(TESTSRCS) > /tmp/.gendep
	cat /tmp/.gendep | sed "s/.o:/-cc.o:/"   >  .depend
	cat /tmp/.gendep | sed "s/.o:/-gcc.o:/"  >> .depend
	cat /tmp/.gendep | sed "s/.o:/-dbg.o:/"  >> .depend
	cat /tmp/.gendep | sed "s/.o:/-prof.o:/" >> .depend
	rm -f /tmp/.gendep

tag:
	ctags *.[ch]
	
test: stress-gcc
	stress-gcc > /dev/null
		
include .depend
