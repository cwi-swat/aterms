# vim:ts=8:sw=8

PRODUCT		= @PRODUCT@
VERSION		= @VERSION@
CURDATE		= `date`

srcdir		= @srcdir@
top_srcdir	= @top_srcdir@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir      	= $(exec_prefix)/bin
libdir      	= $(exec_prefix)/lib
includedir  	= $(prefix)/include

CC_GCC		= @CC_GCC@
CC_CC		= @CC_CC@
CC_DBG		= @CC_DBG@
CC_PROF		= @CC_PROF@
CC_NS		= @CC_CC@

CFLAGS_CC	= @CFLAGS_CC@
CFLAGS_GCC	= @CFLAGS_GCC@
CFLAGS_DBG	= @CFLAGS_DBG@
CFLAGS_PROF	= @CFLAGS_PROF@
CFLAGS_NS	= @CFLAGS_CC@

DEFS		= -DCURDATE="\"${CURDATE}\"" -DVERSION="\"${VERSION}\""
DEFS_CC		= @DEFS_CC@
DEFS_GCC	= @DEFS_GCC@
DEFS_DBG	= @DEFS_DBG@
DEFS_PROF	= @DEFS_PROF@
DEFS_NS		= @DEFS_CC@ -DNO_SHARING

INCL_CC		= @INCL_CC@
INCL_GCC	= @INCL_GCC@
INCL_DBG	= @INCL_DBG@
INCL_PROF	= @INCL_PROF@
INCL_NS		= @INCL_CC@

LFLAGS_CC	= @LFLAGS_CC@
LFLAGS_GCC	= @LFLAGS_GCC@
LFLAGS_DBG	= @LFLAGS_DBG@
LFLAGS_PROF	= @LFLAGS_PROF@
LFLAGS_NS	= @LFLAGS_CC@

LIBS		= @LIBS@

AR		= @AR@
AR_FLAGS	= cr

INSTALL		= @INSTALL@
INSTALL_PRG	= @INSTALL_PRG@
INSTALL_DAT	= @INSTALL_DAT@

SCRIPTS		= baf2trm trm2baf
BINARIES	= termsize baffle
PROGS		= ${BINARIES} ${SCRIPTS}
PROGSRCS	= termsize.c baffle.c
ATERMSRCS	= aterm.c list.c make.c memory.c afun.c gc.c bafio.c \
		version.c
ATERMLIBS	= libATerm-gcc.a libATerm-cc.a libATerm-dbg.a libATerm-prof.a \
		libATerm-ns.a
PUBLIC_INCL	= abool.h aterm1.h aterm2.h deprecated.h encoding.h afun.h
PRIVATE_INCL	= _aterm.h debug.h gc.h list.h make.h memory.h util.h bafio.h \
		version.h
ATERMINCL	= ${PUBLIC_INCL} ${PRIVATE_INCL}
DISTFILES	= Makefile.in .depend ${PROGSRCS} ${ATERMSRCS} ${ATERMINCL} \
			${SCRIPTS}

OBJ_CC		= $(patsubst %.c,%-cc.o,$(ATERMSRCS))
OBJ_GCC		= $(patsubst %.c,%-gcc.o,$(ATERMSRCS))
OBJ_DBG		= $(patsubst %.c,%-dbg.o,$(ATERMSRCS))
OBJ_PROF	= $(patsubst %.c,%-prof.o,$(ATERMSRCS))
OBJ_NS		= $(patsubst %.c,%-ns.o,$(ATERMSRCS))

all: $(ATERMLIBS) $(PROGS)

clean:
	@CLEAN@ ${BINARIES}

dist: ${DISTFILES}
	@cp ${DISTFILES} ${DISTDIR}	

install: all ${PUBLIC_INCL}
	@for file in ${ATERMLIBS}; do \
		${INSTALL_DAT} $$file ${libdir}; \
	done
	@for file in ${PUBLIC_INCL}; do \
		${INSTALL_DAT} $$file ${includedir}; \
	done
	@for file in ${PROGS}; do \
		${INSTALL_PRG} $$file ${bindir}; \
	done

%-cc.o: %.c
	${CC_CC} ${CFLAGS_CC} ${DEFS_CC} -c -o $@ $<

%-gcc.o: %.c
	${CC_GCC} ${CFLAGS_GCC} ${DEFS_GCC} -c -o $@ $<

%-dbg.o: %.c
	${CC_DBG} ${CFLAGS_DBG} ${DEFS_DBG} -c -o $@ $<

%-prof.o: %.c
	${CC_PROF} ${CFLAGS_PROF} ${DEFS_PROF} -c -o $@ $<

%-ns.o: %.c
	${CC_NS} ${CFLAGS_NS} ${DEFS_NS} -c -o $@ $<

libATerm-cc.a: ${OBJ_CC}
	${AR} ${AR_FLAGS} $@ ${OBJ_CC}

libATerm-gcc.a:	${OBJ_GCC}
	${AR} ${AR_FLAGS} $@ ${OBJ_GCC}

libATerm-dbg.a: ${OBJ_DBG}
	${AR} ${AR_FLAGS} $@ ${OBJ_DBG}

libATerm-prof.a: ${OBJ_PROF}
	${AR} ${AR_FLAGS} $@ ${OBJ_PROF}

libATerm-ns.a: ${OBJ_NS}
	${AR} ${AR_FLAGS} $@ ${OBJ_NS}

baffle: baffle.c libATerm-cc.a
	${CC_CC} ${CFLAGS_CC} -o $@ $< -L. -lATerm-cc ${LIBS}

termsize: termsize.c libATerm-cc.a
	${CC_CC} ${CFLAGS_CC} -o $@ $< -L. -lATerm-cc ${LIBS}

version-cc.o: version.c ${ATERMINCL} ${ATERMSRCS}
version-gcc.o: version.c ${ATERMINCL} ${ATERMSRCS}
version-dbg.o: version.c ${ATERMINCL} ${ATERMSRCS}
version-prof.o: version.c ${ATERMINCL} ${ATERMSRCS}
version-ns.o: version.c ${ATERMINCL} ${ATERMSRCS}

tag:
	ctags *.[ch]

depend:
	$(CC_GCC) -MM $(DEFS_CC) $(INCL_CC) $(ATERMSRCS) > /tmp/.gendep
	cat /tmp/.gendep | sed "s/.o:/-cc.o:/"   >  .depend
	$(CC_GCC) -MM $(DEFS_GCC) $(INCL_GCC) $(ATERMSRCS) > /tmp/.gendep
	cat /tmp/.gendep | sed "s/.o:/-gcc.o:/"  >> .depend
	$(CC_GCC) -MM $(DEFS_DBG) $(INCL_DBG) $(ATERMSRCS) > /tmp/.gendep
	cat /tmp/.gendep | sed "s/.o:/-dbg.o:/"  >> .depend
	$(CC_GCC) -MM $(DEFS_PROF) $(INCL_PROF) $(ATERMSRCS) > /tmp/.gendep
	cat /tmp/.gendep | sed "s/.o:/-prof.o:/" >> .depend
	$(CC_GCC) -MM $(DEFS_NS) $(INCL_NS) $(ATERMSRCS) > /tmp/.gendep
	cat /tmp/.gendep | sed "s/.o:/-ns.o:/" >> .depend
	$(CC_GCC) -MM $(DEFS_GCC) $(INCL_GCC) $(PROGSRCS) >> .depend
	rm -f /tmp/.gendep

include .depend
